Releases
========

v1.0.0-dev (unreleased)
-----------------------

-   **Breaking**: Rename `Channel` to `ClientConfig` for both the dispatcher
    method and the interface. `mydispatcher.Channel("myservice")` becomes
    `mydispatcher.ClientConfig("myservice")`. The `ClientConfig` object can
    then used to build a new Client as before:
    `NewMyThriftClient(mydispatcher.ClientConfig("myservice"))`.
-   A comment is added atop YAML files generated by the recorder to help
    understanding where they come from.
-   **Breaking**: the HTTP inbound constructor now accepts only a
    `peer.Chooser`.  For convenience, the common case of an outbound to a
    single peer may use a single peer chooser. Peer choosers require a
    transport to get the unique peer for a peer identifier.

    Before:

    ```go
    yarpc.NewDispatcher(yarpc.Config{
        yarpc.Outbounds{
            "callee": http.NewOutbound("http://127.0.0.1:80/rpc/v1")
        },
    })
    ```

    After:

    ```go
    httpTransport := http.NewTransport()
    yarpc.NewDispatcher(yarpc.Config{
        yarpc.Outbounds{
            "callee": http.NewOutbound(single.New(
                hostport.PeerIdentifier("127.0.0.1:80"),
                httpTransport,
            )).WithURLTemplate("http://host:port/rpc/v1")
        },
    })
    ```

-   **Breaking**: the `transport.Inbound` and `transport.Outbound` interfaces
    now implement `Start()` without any arguments.

    The dispatcher no longer threads a dependencies object through the start
    method of every configured transport. The only existing dependency was an
    opentracing Tracer, which you must now manually configure on each
    transport.

    Before:

    ```go
    yarpc.NewDispatcher(yarpc.Config{
        yarpc.Inbounds{
            http.NewInbound(...),
        },
        yarpc.Outbounds{
            "callee": http.NewOutbound(...)
        },
        Tracer: opentracing.GlobalTracer(),
    })
    ```

    Now:

    ```go
    tracer := opentracing.GlobalTracer()
    yarpc.NewDispatcher(yarpc.Config{
        yarpc.Inbounds{
            http.NewInbound(...)
                .WithTracer(tracer),
        },
        yarpc.Outbounds{
            "callee": http.NewOutbound(...).
                WithTracer(tracer)
        },
    })
    ```

    The `yarpc.Config` `Tracer` property is still accepted, but unused and
    deprecated.

    The dispatcher no longer provides a `transport.ServiceDetail` as an
    argument to `Start` on inbound transports.  The `transport.ServiceDetail`
    no longer exists.  You no longer need to provide the service name to start
    an inbound, only a registry.  Instead of passing the service detail to start,
    the dispatcher now calls `inbound.SetRegistry(transport.Registry)` before
    calling `Start()`.

    Custom transport protocols must change their interface accordingly to
    satisfy the `transport.Inbound` interface.  Uses that construct inbounds
    manually must either call `SetRegistry` or use the `WithRegistry` chained
    configuration method before calling `Start` without a `ServiceDetail`.

    Before:

    ```go
    inbound := tchannel.NewInbound(ch)
    err := inbound.Start(
        transport.ServiceDetail{
            Name: "service",
            Registry: registry,
        },
        transport.NoDeps,
    )
    ```

    Now:

    ```go
    inbound := tchannel.NewInboundFromChannel(ch).
        WithRegistry(registry)
    err := inbound.Start()
    ```

    The `transport.Deps` struct and `transport.NoDeps` instance no longer exist.

-   **Breaking**: TChannel inbound and outbound constructors now return
    pointers to Inbound and Outbound structs with private state satisfying the
    `transport.Inbound` and `transport.Outbound` interfaces.  These were
    previously transport specific Inbound and Outbound interfaces.
    This eliminates unnecessary polymorphism in some cases.

-   **Breaking**: the HTTP and TChannel Inbound and Outbound transports no longer
    support optional arguments.  Instead, you must chain `With*` methods.

    Before:

    ```go
    tchannel.NewOutbound(channel, tchannel.HostPort("127.0.0.1:4040")
    ```

    Now:

    ```go
    tchannel.NewOutbound(channel).WithHostPort("127.0.0.1:4040")
    ```

    This change applies to:

    -   WithHostPort on TChannel outbound
    -   WithListenAddr on TChannel inbound
    -   WithMux on HTTP inbound
    -   WithURLTemplate on HTTP outbounds **new**
    -   WithTracer on all transports **new**

v1.0.0-rc1 (2016-11-23)
-----------------------

-   **Breaking**: Rename the `Interceptor` and `Filter` types to
    `UnaryInboundMiddleware` and `UnaryOutboundMiddleware` respectively.
-   **Breaking**: `yarpc.Config` now accepts middleware using the
    `InboundMiddleware` and `OutboundMiddleware` fields.

    Before:

        yarpc.Config{Interceptor: myInterceptor, Filter: myFilter}

    Now:

        yarpc.Config{
            InboundMiddleware: yarpc.InboundMiddleware{Unary: myInterceptor},
            OutboundMiddleware: yarpc.OutboundMiddleware{Unary: myFilter},
        }

-   Add support for Oneway middleware via the `OnewayInboundMiddleware` and
    `OnewayOutboundMiddleware` interfaces.


v0.5.0 (2016-11-21)
-------------------

-   **Breaking**: A detail of inbound transports has changed.
    Starting an inbound transport accepts a ServiceDetail, including
    the service name and a Registry. The Registry now must
    implement `Choose(context.Context, transport.Request) (HandlerSpec, error)`
    instead of `GetHandler(service, procedure string) (HandlerSpec, error)`.
    Note that in the prior release, `Handler` became `HandleSpec` to
    accommodate oneway handlers.
-   Upgrade to ThriftRW 1.0.
-   TChannel: `NewInbound` and `NewOutbound` now accept any object satisfying
    the `Channel` interface. This should work with existing `*tchannel.Channel`
    objects without any changes.
-   Introduced `yarpc.Inbounds` to be used instead of `[]transport.Inbound`
    when configuring a Dispatcher.
-   Add support for peer lists in HTTP outbounds.


v0.4.0 (2016-11-11)
-------------------

This release requires regeneration of ThriftRW code.

-   **Breaking**: Procedure registration must now always be done directly
    against the `Dispatcher`. Encoding-specific functions `json.Register`,
    `raw.Register`, and `thrift.Register` have been deprecated in favor of
    the `Dispatcher.Register` method. Existing code may be migrated by running
    the following commands on your go files.

    ```
    gofmt -w -r 'raw.Register(d, h) -> d.Register(h)' $file.go
    gofmt -w -r 'json.Register(d, h) -> d.Register(h)' $file.go
    gofmt -w -r 'thrift.Register(d, h) -> d.Register(h)' $file.go
    ```
-   Add `yarpc.InjectClients` to automatically instantiate and inject clients
    into structs that need them.
-   Thrift: Add a `Protocol` option to change the Thrift protocol used by
    clients and servers.
-   **Breaking**: Remove the ability to set Baggage Headers through yarpc, use
    opentracing baggage instead
-   **Breaking**: Transport options have been removed completely. Encoding
    values differently based on the transport is no longer supported.
-   **Breaking**: Thrift requests and responses are no longer enveloped by
    default. The `thrift.Enveloped` option may be used to turn enveloping on
    when instantiating Thrift clients or registering handlers.
-   **Breaking**: Use of `golang.org/x/net/context` has been dropped in favor
    of the standard library's `context` package.
-   Add support for providing peer lists to dynamically choose downstream
    peers in HTTP Outbounds
-   Rename `Handler` interface to `UnaryHandler` and separate `Outbound`
    interface into `Outbound` and `UnaryOutbound`.
-   Add `OnewayHandler` and `HandlerSpec` to support oneway handlers.
    Transport inbounds can choose which RPC types to accept
-   The package `yarpctest.recorder` can be used to record/replay requests
    during testing. A command line flag (`--recorder=replay|append|overwrite`)
    is used to control the mode during the execution of the test.


v0.3.1 (2016-09-31)
-------------------

-   Fix missing canonical import path to `go.uber.org/yarpc`.


v0.3.0 (2016-09-30)
-------------------

-   **Breaking**: Rename project to `go.uber.org/yarpc`.
-   **Breaking**: Switch to `go.uber.org/thriftrw ~0.3` from
    `github.com/thriftrw/thriftrw-go ~0.2`.
-   Update opentracing-go to `>= 1, < 2`.


v0.2.1 (2016-09-28)
-------------------

-   Loosen constraint on `opentracing-go` to `>= 0.9, < 2`.


v0.2.0 (2016-09-19)
-------------------

-   Update thriftrw-go to `>= 0.2, < 0.3`.
-   Implemented a ThriftRW plugin. This should now be used instead of the
    ThriftRW `--yarpc` flag. Check the documentation of the
    [thrift](https://godoc.org/github.com/yarpc/yarpc-go/encoding/thrift)
    package for instructions on how to use it.
-   Adds support for [opentracing][]. Pass an opentracing instance as a
    `Tracer` property of the YARPC config struct and both TChannel and HTTP
    transports will submit spans and propagate baggage.
-   This also modifies the public interface for transport inbounds and
    outbounds, which must now accept a transport.Deps struct. The deps struct
    carries the tracer and may eventually carry other dependencies.
-   Panics from user handlers are recovered. The panic is logged (stderr), and
    an unexpected error is returned to the client about it.
-   Thrift clients can now make requests to multiplexed Apache Thrift servers
    using the `thrift.Multiplexed` client option.

[opentracing]: http://opentracing.io/


v0.1.1 (2016-09-01)
-------------------

-   Use `github.com/yarpc/yarpc-go` as the import path; revert use of
    `go.uber.org/yarpc` vanity path. There is an issue in Glide `0.11` which
    causes installing these packages to fail, and thriftrw `~0.1`'s yarpc
    template is still using `github.com/yarpc/yarpc-go`.


v0.1.0 (2016-08-31)
-------------------

-   Initial release.
